study("Volatility Stop", "VStop", overlay=true, resolution="")
length = input(20, "Length", minval = 2) #lenght = 20
src = input(close, "Source") 
factor = input(2.0, "Multiplier", minval = 0.25, step = 0.25) #factor = 2
volStop(src, atrlen, atrfactor) =>
    var max     = src #max = curr close if there is no max already
    var min     = src #min = curr close if there is no min already
    var uptrend = true #initialize uptrend to true
    var stop    = 0.0 # initialize stop to 0
    atrM        = nz(atr(atrlen) * atrfactor, tr) # atr factor
    max         := max(max, src)
    min         := min(min, src)
    stop        := nz(uptrend ? max(stop, max - atrM) : min(stop, min + atrM), src) #new stop if uptrend or downtrend
    uptrend     := src - stop >= 0.0
    if uptrend != nz(uptrend[1], true)
        max    := src
        min    := src
        stop   := uptrend ? max - atrM : min + atrM
    [stop, uptrend]

[vStop, uptrend] = volStop(src, length, factor)